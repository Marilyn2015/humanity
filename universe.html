<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>#HUMANITY Universe</title>

  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=Merriweather:wght@300;400;700&display=swap" rel="stylesheet">

  <!-- Three.js & Firebase -->
  <script src="https://unpkg.com/three@0.128.0/build/three.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>

  <style>
    * { box-sizing: border-box; margin:0; padding:0; }
    body {
      background: #ffffff;
      color: #202020;
      font-family: 'Merriweather', serif;
      text-align: center;
      padding: 20px;
    }
    h1 {
      font-family: 'Playfair Display', serif;
      font-size: 2.4rem;
      margin: 16px 0;
    }
    #globeCanvas {
      display: block; margin: 0 auto 16px;
      width: 90vw; max-width: 380px; height: 380px;
    }
    #openModal {
      background: #000; color: #fff;
      border: none; border-radius: 6px;
      padding: 12px 32px; font-size:1rem;
      cursor:pointer; margin-bottom:16px;
      font-family:'Merriweather', serif;
    }
    #openModal:hover { background:#333; }
    .modal {
      display:none; position:fixed;
      top:0;left:0;right:0;bottom:0;
      background:rgba(0,0,0,0.1);
      justify-content:center;align-items:center;
      z-index:999;
    }
    .modal.show { display:flex; }
    .modal-content {
      background:#f0f0f0; padding:24px;
      border-radius:12px; max-width:360px; width:90vw;
      text-align:left; box-shadow:0 4px 12px rgba(0,0,0,0.2);
    }
    .modal-content h2 {
      font-family:'Playfair Display', serif;
      margin-top:0; margin-bottom:12px;
    }
    .modal-content textarea {
      width:100%; min-height:80px;
      padding:8px; border:1px solid #ccc;
      border-radius:6px; resize:vertical;
      font-family:'Merriweather', serif;
    }
    .modal-content input[type=file] {
      margin:12px 0; width:100%;
    }
    #imagePreview {
      max-width:100%; display:none; margin-bottom:12px;
    }
    .modal-actions {
      text-align:right;
    }
    .modal-actions button {
      font-family:'Merriweather', serif;
      padding:8px 20px; border:none; border-radius:6px;
      margin-left:8px; cursor:pointer;
    }
    #postButton {
      background:#000; color:#fff;
    }
    #postButton:hover { background:#333; }
    #closeModal {
      background:#fff; color:#000; border:1px solid #ccc;
    }
    #closeModal:hover { background:#e0e0e0; }
    #postsContainer {
      margin:24px auto; max-width:600px; text-align:left;
    }
    .post-item {
      background:#f0f0f0; border:1px solid #ccc;
      border-radius:12px; padding:16px; margin-bottom:20px;
      display:flex; gap:12px; align-items:flex-start;
    }
    .avatar { width:48px;height:48px;border-radius:50%;object-fit:cover; }
    .post-content { flex:1; }
    .post-content .username { font-weight:700; margin-right:8px; }
    .post-content .timestamp { font-size:.85rem; color:#555; }
    .post-content .text { margin:8px 0; }
    .uploaded { max-width:200px; margin-top:8px; border-radius:6px; }
    .like-btn, .delete-btn {
      padding:6px 12px; border:none; border-radius:6px; cursor:pointer;
      font-family:'Merriweather', serif; font-weight:700; margin-right:8px;
    }
    .like-btn { background:#fff; border:1px solid #ccc; }
    .like-btn:hover { background:#ddd; }
    .delete-btn { background:#800; color:#fff; }
    .delete-btn:hover { background:#a00; }
  </style>
</head>

<body>
  <h1>The Universe</h1>
  <canvas id="globeCanvas" width="400" height="400"></canvas>
  <button id="openModal">üìù New Post</button>

  <div id="postModal" class="modal">
    <div class="modal-content">
      <h2>Feed the Human Feed‚Ä¶</h2>
      <textarea id="newPostContent" placeholder="What‚Äôs on your mind?"></textarea>
      <input type="file" id="postImageUpload" accept="image/*">
      <img id="imagePreview" alt="Preview">
      <div class="modal-actions">
        <button id="postButton">Post</button>
        <button id="closeModal">Cancel</button>
      </div>
    </div>
  </div>

  <div id="postsContainer"></div>

  <script>
    // --- Firebase init ---
    const firebaseConfig = {
      apiKey: "AIzaSyBT7P7DAfV-I9ESe6f9Jdp5ioCyGIK0d9A",
      authDomain: "hashhumanity-58b9a.firebaseapp.com",
      databaseURL: "https://hashhumanity-58b9a-default-rtdb.firebaseio.com",
      projectId: "hashhumanity-58b9a",
      storageBucket: "hashhumanity-58b9a.appspot.com",
      messagingSenderId: "886745899016",
      appId: "1:886745899016:web:2b0f7e0434379d71bd"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db   = firebase.database();
    const storage = firebase.storage();

    let currentUserProfile = null;

    // 1) Ensure user is signed in
    auth.onAuthStateChanged(async user => {
      if (!user) {
        // not logged in ‚Üí redirect to login.html
        window.location.href = 'login.html';
        return;
      }
      const uid = user.uid;
      console.log('Logged in UID:', uid);

      // 2) Load profile from /users/{uid}
      const snap = await db.ref(`users/${uid}`).once('value');
      currentUserProfile = snap.val();
      console.log('Loaded profile:', currentUserProfile);

      // If profile missing, send back to createProfile.html
      if (!currentUserProfile || !currentUserProfile.username) {
        window.location.href = 'createProfile.html';
        return;
      }
    });

    // --- Modal logic ---
    const openModalBtn  = document.getElementById('openModal'),
          postModal     = document.getElementById('postModal'),
          closeModalBtn = document.getElementById('closeModal'),
          postButton    = document.getElementById('postButton'),
          previewImg    = document.getElementById('imagePreview'),
          textArea      = document.getElementById('newPostContent'),
          fileInput     = document.getElementById('postImageUpload');

    openModalBtn.onclick = () => {
      postModal.classList.add('show');
      previewImg.style.display = 'none';
      textArea.value = '';
      fileInput.value = '';
    };
    closeModalBtn.onclick = () => postModal.classList.remove('show');

    fileInput.addEventListener('change', ()=>{
      const file = fileInput.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = () => {
          previewImg.src = reader.result;
          previewImg.style.display = 'block';
        };
        reader.readAsDataURL(file);
      } else {
        previewImg.style.display = 'none';
      }
    });

    // --- Posting ---
    postButton.onclick = async () => {
      if (!currentUserProfile) {
        alert('Profile not loaded. Please reload.');
        return;
      }
      const content = textArea.value.trim();
      const file    = fileInput.files[0];
      if (!content && !file) {
        alert('Enter text or choose an image.');
        return;
      }

      // upload image if any
      let imageUrl = '';
      if (file) {
        const path = `postImages/${auth.currentUser.uid}_${Date.now()}_${file.name}`;
        const snap = await storage.ref(path).put(file);
        imageUrl = await snap.ref.getDownloadURL();
      }

      // push to /posts
      await db.ref('posts').push({
        uid: auth.currentUser.uid,
        username: currentUserProfile.username,
        avatar: currentUserProfile.avatar,
        content,
        imageUrl,
        timestamp: Date.now(),
        likes: 0
      });

      postModal.classList.remove('show');
    };

    // --- Display posts ---
    const postsContainer = document.getElementById('postsContainer');
    function renderPost(p, key) {
      const div = document.createElement('div');
      div.className = 'post-item';

      const img = document.createElement('img');
      img.className = 'avatar';
      img.src = p.avatar || 'https://via.placeholder.com/48';
      div.appendChild(img);

      const cd = document.createElement('div');
      cd.className = 'post-content';
      cd.innerHTML = `
        <span class="username">${p.username}</span>
        <span class="timestamp">${new Date(p.timestamp).toLocaleString()}</span>
        <div class="text">${p.content.replace(/</g,'&lt;')}</div>
        ${p.imageUrl ? `<img class="uploaded" src="${p.imageUrl}">` : ''}
      `;
      div.appendChild(cd);

      // like button
      const likeBtn = document.createElement('button');
      likeBtn.className = 'like-btn';
      likeBtn.innerHTML = `üëç <span>${p.likes||0}</span>`;
      likeBtn.onclick = ()=>{
        db.ref(`posts/${key}`).transaction(x=>{
          if (x) x.likes=(x.likes||0)+1;
          return x;
        });
      };
      cd.appendChild(likeBtn);

      // delete button (only by owner)
      if (auth.currentUser && p.uid === auth.currentUser.uid) {
        const delBtn = document.createElement('button');
        delBtn.className = 'delete-btn';
        delBtn.textContent = 'Delete';
        delBtn.onclick = ()=>{
          if (confirm('Delete this post?')) {
            db.ref(`posts/${key}`).remove();
            if (p.imageUrl) {
              const path = decodeURIComponent(p.imageUrl.split('/o/')[1].split('?')[0]);
              storage.ref(path).delete().catch(()=>{});
            }
          }
        };
        cd.appendChild(delBtn);
      }

      postsContainer.prepend(div);
    }

    // Listen for updates
    db.ref('posts').on('value', snap => {
      postsContainer.innerHTML = '';
      snap.forEach(child => renderPost(child.val(), child.key));
    });

    // --- Spinning Globe ---
    const canvas   = document.getElementById('globeCanvas');
    const renderer = new THREE.WebGLRenderer({ canvas, alpha: true });
    renderer.setSize(400, 400);
    const scene    = new THREE.Scene();
    const camera   = new THREE.PerspectiveCamera(50,1,0.1,1000);
    camera.position.z=3;
    const loader   = new THREE.TextureLoader();
    const earthTex = loader.load('https://threejs.org/examples/textures/land_ocean_ice_cloud_2048.jpg');
    const sphere   = new THREE.Mesh(
      new THREE.SphereGeometry(1,32,32),
      new THREE.MeshStandardMaterial({ map: earthTex })
    );
    scene.add(sphere);
    const light = new THREE.DirectionalLight(0xffffff,1.2);
    light.position.set(5,3,5);
    scene.add(light);
    (function animate(){
      requestAnimationFrame(animate);
      sphere.rotation.y += 0.002;
      renderer.render(scene, camera);
    })();
  </script>
</body>
</html>